â€¢ Card Number: 13-19 digits
â€¢ Expiry: MMYY format (e.g., 0125 for Jan 2025)
â€¢ CVV: 3-4 digits

**ğŸ›¡ï¸ SECURITY:**
â€¢ Only authorized users can access
â€¢ Card numbers are masked in logs
â€¢ Secure Braintree gateway
â€¢ No card data stored

**ğŸ“Š STATISTICS:**
View your check history and success rates with `ğŸ“Š My Stats`

**ğŸ†˜ SUPPORT:**
Contact admin for access issues or technical problems
    """
    
    await update.message.reply_text(help_text)

async def admin_panel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id != ADMIN_ID:
        await update.message.reply_text("ğŸš« **Admin Access Required**")
        return
    
    conn = sqlite3.connect('braintree_bot.db')
    c = conn.cursor()
    
    # Get total statistics
    c.execute("SELECT COUNT(*) FROM authorized_users")
    total_users = c.fetchone()[0]
    
    c.execute("SELECT COUNT(*) FROM check_logs")
    total_checks = c.fetchone()[0]
    
    c.execute("SELECT COUNT(*) FROM check_logs WHERE result LIKE '%APPROVED%'")
    approved_checks = c.fetchone()[0]
    
    c.execute("SELECT COUNT(DISTINCT user_id) FROM check_logs WHERE DATE(timestamp) = DATE('now')")
    active_today = c.fetchone()[0]
    
    conn.close()
    
    admin_text = f"""
ğŸ‘‘ **ADMIN CONTROL PANEL** ğŸ› ï¸

**ğŸ“ˆ SYSTEM STATISTICS:**
â€¢ Total Users: `{total_users}`
â€¢ Total Checks: `{total_checks}`
â€¢ Approved: `{approved_checks}`
â€¢ Success Rate: `{(approved_checks/total_checks*100) if total_checks > 0 else 0:.1f}%`
â€¢ Active Today: `{active_today}`

**ğŸ”§ ADMIN COMMANDS:**
â€¢ `/adduser <user_id>` - Add new user
â€¢ `/stats` - Detailed statistics
â€¢ `/broadcast <message>` - Broadcast to all users

**ğŸŒ GATEWAY STATUS:**
â€¢ Braintree: âœ… **Connected**
â€¢ Database: âœ… **Operational**
â€¢ Bot: âœ… **Running**
    """
    
    await update.message.reply_text(admin_text)

async def add_user_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id != ADMIN_ID:
        return
    
    if not context.args:
        await update.message.reply_text("Usage: /adduser <user_id>")
        return
    
    try:
        new_user_id = int(context.args[0])
        add_user(new_user_id)
        await update.message.reply_text(f"âœ… User `{new_user_id}` added successfully!")
    except ValueError:
        await update.message.reply_text("âŒ Invalid user ID format")

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("âŒ Operation cancelled.")
    return ConversationHandler.END

# === MAIN APPLICATION ===
def main():
    # Initialize database
    init_db()
    
    # Create application
    application = Application.builder().token(BOT_TOKEN).build()
    
    # Add admin user
    add_user(ADMIN_ID, "admin")
    
    # Conversation handlers
    cc_conv_handler = ConversationHandler(
        entry_points=[
            MessageHandler(filters.Regex('^ğŸ” Check CC$'), handle_check_cc),
            CommandHandler('check', handle_check_cc)
        ],
        states={
            'AWAITING_CC_DETAILS': [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_cc_details)
            ],
            'AWAITING_CUSTOM_AMOUNT': [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_custom_amount)
            ],
        },
        fallbacks=[CommandHandler('cancel', cancel)]
    )
    
    mode_conv_handler = ConversationHandler(
        entry_points=[
            MessageHandler(filters.Regex('^ğŸ› ï¸ Check Mode$'), check_mode_menu),
            CommandHandler('mode', check_mode_menu)
        ],
        states={
            'AWAITING_CUSTOM_AMOUNT': [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_custom_amount)
            ],
        },
        fallbacks=[CommandHandler('cancel', cancel)]
    )
    
    # Add handlers
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("stats", show_stats))
    application.add_handler(CommandHandler("admin", admin_panel))
    application.add_handler(CommandHandler("adduser", add_user_command))
    
    application.add_handler(cc_conv_handler)
    application.add_handler(mode_conv_handler)
    application.add_handler(CallbackQueryHandler(handle_mode_callback, pattern="^mode_"))
    
    # Text message handlers
    application.add_handler(MessageHandler(filters.Regex('^ğŸ“Š My Stats$'), show_stats))
    application.add_handler(MessageHandler(filters.Regex('^â„¹ï¸ Help$'), help_command))
    
    # Start the bot
    print("ğŸš€ Braintree CC Checker Bot is running...")
    print(f"ğŸ¤– Bot Token: {BOT_TOKEN}")
    print(f"ğŸ‘‘ Admin ID: {ADMIN_ID}")
    print("ğŸ’³ Gateway: Braintree")
    print("ğŸ“Š Database: braintree_bot.db")
    
    application.run_polling()

if __name__ == '__main__':
    main()